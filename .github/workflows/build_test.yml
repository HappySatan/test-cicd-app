name: Build and Test

on:
    push:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2
            - name: Set up Python Environment
              uses: actions/setup-python@v2
              with:
                  python-version: "3.x"
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run Tests
              run: |
                  python manage.py test

    deploy:
        needs: [test]
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source code
              uses: actions/checkout@v2

            - name: Generate deployment package
              run: zip -r deploy.zip . -x '*.git*'

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: "us-east-2"

            # - name: Copying file to S3
            #   run: aws s3 cp deploy.zip s3://elasticbeanstalk-us-east-2-734766867964/cicd-retesting-application-django/
            - name: success Message
              run: echo "CI part finished successfuly"

            - name: Deploy to EB
              uses: einaregilsson/beanstalk-deploy@v20
              with:
                  aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  use_existing_version_if_available: true
                  application_name: cicd-retesting-application-django
                  environment_name: Cicdretestingapplicationdjango-env
                  version_label: 2.1
                  region: "us-east-2"
                  deployment_package: deploy.zip

            # - name: Deploy new app
            #   run: aws elasticbeanstalk update-environment --environment-name --version-label 1.0
            - name: Print nice message on success finish
              run: echo "CD part finished successfuly"
